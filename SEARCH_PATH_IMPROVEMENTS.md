# üîß –£–õ–£–ß–®–ï–ù–ò–Ø –°–ò–°–¢–ï–ú–´ SEARCH_PATH

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

**–î–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π:** `search_path` –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è 2 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π (`user_kirill` –∏ `user_denis`), —á—Ç–æ –æ–∑–Ω–∞—á–∞–ª–æ, —á—Ç–æ –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É `search_path`.

```python
# ‚ùå –°–¢–ê–†–´–ô –ö–û–î - —Ç–æ–ª—å–∫–æ –¥–ª—è 2 —Ä–æ–ª–µ–π
if user_role in ["user_kirill", "user_denis"]:
    await connection.execute("SET search_path TO demo1, public")
```

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

**–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:** `search_path` –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏** –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Ö —Å—Ö–µ–º—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

### 1. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ search_path

```python
# ‚úÖ –ù–û–í–´–ô –ö–û–î - –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_schema = await self._get_user_schema(user_id)
if user_schema and user_schema != "public":
    await connection.execute(f"SET search_path TO {user_schema}, public")
    logger.info(f"üîç Set search_path to {user_schema}, public for {user_role}")
else:
    # –î–ª—è —Ä–æ–ª–µ–π –±–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π —Å—Ö–µ–º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ public
    await connection.execute("SET search_path TO public")
    logger.info(f"üîç Set search_path to public for {user_role}")
```

### 2. –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ö–µ–º—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
async def _get_user_schema(self, user_id: str) -> str:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å—Ö–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        str: –°—Ö–µ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
    """
    query = """
    SELECT schema_name 
    FROM users_role_bd_mapping 
    WHERE user_id::VARCHAR = $1
    LIMIT 1
    """
    
    result = await app_database_service.execute_query(query, [user_id])
    
    if result.data:
        schema_name = result.data[0]['schema_name']
        return schema_name
    else:
        return None
```

### 3. –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–µ–π –≤ Admin Panel

```python
def create_postgresql_role(role_name, database_name, schema_name="public"):
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏ –≤ PostgreSQL —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π search_path"""
    
    # ... —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏ ...
    
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º search_path –¥–ª—è —Ä–æ–ª–∏
    if schema_name and schema_name != "public":
        search_path_query = f"ALTER ROLE {role_name} SET search_path TO {schema_name}, public"
        conn.execute(text(search_path_query))
        logging.info(f'Search_path —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è —Ä–æ–ª–∏ {role_name}: {schema_name}, public')
    else:
        search_path_query = f"ALTER ROLE {role_name} SET search_path TO public"
        conn.execute(text(search_path_query))
        logging.info(f'Search_path —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è —Ä–æ–ª–∏ {role_name}: public')
```

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

### ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å
- **–†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**, –Ω–µ —Ç–æ–ª—å–∫–æ –¥–ª—è `user_kirill` –∏ `user_denis`
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞** –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ö–µ–º—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- **–ì–∏–±–∫–æ—Å—Ç—å** - –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–≤–æ—é —Å—Ö–µ–º—É

### ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–æ–ª–µ–π —á–µ—Ä–µ–∑ Admin Panel
- **–ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏** –≤ —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `search_path`

### ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- **–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - fallback –Ω–∞ `public` –µ—Å–ª–∏ —Å—Ö–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

## üìä –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Å—Ö–µ–º–æ–π demo1
```sql
-- –í users_role_bd_mapping:
user_id: 4ed3d75a-482d-4993-a3bb-eba666b5dea2
schema_name: demo1

-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
SET search_path TO demo1, public
```

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Å—Ö–µ–º–æ–π public
```sql
-- –í users_role_bd_mapping:
user_id: 69ccad66-ea6d-40d3-9986-10c5d92c0259
schema_name: public

-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
SET search_path TO public
```

### –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
```sql
-- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–µ—Ä–µ–∑ Admin Panel:
role_name: user_new
database_name: test1
schema_name: demo2

-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
ALTER ROLE user_new SET search_path TO demo2, public
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç `test_new_user_search_path.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã:

```bash
python test_new_user_search_path.py
```

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É `search_path` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º `search_path`
- ‚úÖ –û–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

## üìù –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`backend/services/data_database.py`**
   - –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_get_user_schema()`
   - –ò–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `search_path` –≤ `execute_query_with_user()`

2. **`admin-panel/app.py`**
   - –£–ª—É—á—à–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `create_postgresql_role()` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π `schema_name`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `add_table_permission()` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Å—Ö–µ–º—ã

3. **`test_new_user_search_path.py`** (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
   - –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç `search_path` –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Ö —Å—Ö–µ–º—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

- üîß **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- üöÄ **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- üõ°Ô∏è **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - fallback –Ω–∞ `public` –µ—Å–ª–∏ —Å—Ö–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
- üìà **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

